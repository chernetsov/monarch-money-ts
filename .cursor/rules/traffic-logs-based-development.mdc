---
alwaysApply: true
---

# Traffic Logs and mmtraf tool

According to convention user puts gitignored traffic logs under traffic/ directory.
This repository has a tool called mmtraf that simplifies working with these traffic logs. You have to read [mmtraf.md](../../mmtraf.md) for usage docs. Always use this tool to look at the contents of traffic log files (they are too large to load into context directly).

First see the list of files using `list`, then use `summary` to find the request of interest. Next, inspect the request with `body:req-at` and `graphql:req-at`, infer the response schema with `schema:res-at`, and walk the response body using `body:res-at` and jq.

# Building APIs

When building APIs after looking at requests and responses, follow the following rules and conventions:

- **api.ts (domain API modules)**:
  - **Auth and client**: API functions accept `auth: AuthProvider` and `client: MonarchGraphQLClient` as the first params.
  - **Function names**: Prefer descriptive verbs like `getAccounts(auth, client, filters?)`.
  - **GraphQL**: Use `gql` tagged templates and pass variables (e.g., `$filters: AccountFilters`) instead of hardcoding filters.
  - **Parsing**: Always validate GraphQL responses with a Zod schema from the corresponding `types.ts` and return the parsed, typed data (not raw `data`).
  - **Error handling**: Rely on `MonarchGraphQLClient` to handle auth retries and wrap errors; do not silently coerce.
  - **Exports**: Re-export from `src/new/index.ts` to provide a stable surface.

- **types.ts (domain schema modules, e.g., accounts-types.ts)**:
  - **Zod strictness**: Use `.strict()` on object schemas to catch unexpected fields.
  - **Nullability**: Express nullability at the property level using `.nullable()`; avoid schema-level nullability and avoid silent coercion (no `.catch(undefined)`).
  - **Optional vs nullable**: Reserve `.optional()` for genuinely omitted fields; prefer `z.string().nullable()` for optional text that may be `null` in responses.
  - **Variability**: For highly variable sub-objects (e.g., `plaidStatus`), use `z.unknown().optional()` and refine later if needed.
  - **Types**: Export both the Zod schemas and `z.infer<>` TypeScript types for consumers.
  - **Inputs**: Define input types (e.g., `AccountFiltersInput`) to mirror traffic-observed filters without over-fitting.

- **int.test.ts (integration tests)**:
  - **Setup**: Use `getIntegrationContext()` from `src/new/test-utils.ts` to obtain `auth` and `client`.
  - **Env**: Tests rely on `MONARCH_EMAIL`, `MONARCH_PASSWORD`, and optional `MONARCH_OTP_KEY`.
  - **Assertions**: Validate array shape and presence of key fields (e.g., `id`, `displayName`, `type`) rather than snapshots.
  - **Scope**: Exercise real GraphQL endpoints; prefer simple, robust expectations to handle live data variance.
  - **Naming**: Group by feature (e.g., `describe('integration: accounts', ...)`).
